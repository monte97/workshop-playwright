<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>I miei Ordini - TechStore</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    main {
      padding: 2rem 0;
    }

    .order-card {
      background: white;
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: var(--card-shadow);
      margin-bottom: 1.5rem;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1rem;
    }

    .order-number {
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--primary-color);
    }

    .order-date {
      color: var(--secondary-color);
      font-size: 0.875rem;
    }

    .order-status {
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .order-status.pending {
      background: #fef3c7;
      color: #92400e;
    }

    .order-status.completed {
      background: #d1fae5;
      color: #065f46;
    }

    .order-items {
      margin: 1rem 0;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
    }

    .order-item-details {
      color: var(--secondary-color);
      font-size: 0.875rem;
    }

    .order-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
      margin-top: 1rem;
    }

    .order-total {
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--primary-color);
    }

    .empty-orders {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--secondary-color);
    }

    .empty-orders-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .shipping-address {
      background: var(--background);
      padding: 1rem;
      border-radius: 0.375rem;
      margin-top: 1rem;
      font-size: 0.875rem;
    }

    .shipping-address strong {
      display: block;
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <a href="/" class="logo">üõí TechStore</a>
      <nav>
        <a href="/">Prodotti</a>
        <span class="user-info">
          <span id="userGreeting" class="hidden"></span>
          <a href="/login" id="loginLink">Login</a>
          <a href="/orders" id="ordersLink" class="hidden">Ordini</a>
          <a href="/admin/products" id="adminLink" class="hidden">Admin</a>
          <button id="logoutBtn" class="btn btn-sm btn-outline hidden">Logout</button>
        </span>
        <a href="/cart" class="cart-badge">
          üõí Carrello
          <span id="cartBadge" class="badge hidden">0</span>
        </a>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <h1 class="mb-3">I miei Ordini</h1>

      <div id="loginRequired" class="alert alert-info hidden">
        Devi effettuare il <a href="/login">login</a> per visualizzare i tuoi ordini.
      </div>

      <div id="emptyOrders" class="card empty-orders hidden">
        <div class="empty-orders-icon">üì¶</div>
        <h2>Nessun ordine trovato</h2>
        <p>Non hai ancora effettuato acquisti</p>
        <a href="/" class="btn btn-primary mt-3">Inizia a fare shopping</a>
      </div>

      <div id="ordersContainer"></div>
    </div>
  </main>

  <script src="/js/common.js"></script>
  <script>
    let currentUser = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      currentUser = await checkAuth();

      if (!currentUser) {
        document.getElementById('loginRequired').classList.remove('hidden');
        return;
      }

      await loadOrders();
    });

    // Load orders
    async function loadOrders() {
      try {
        const response = await fetch('/api/orders');

        if (!response.ok) {
          throw new Error('Failed to load orders');
        }

        const orders = await response.json();
        displayOrders(orders);
      } catch (error) {
        console.error('Error loading orders:', error);
      }
    }

    // Display orders
    function displayOrders(orders) {
      const container = document.getElementById('ordersContainer');
      const emptyOrders = document.getElementById('emptyOrders');

      if (orders.length === 0) {
        emptyOrders.classList.remove('hidden');
        return;
      }

      container.innerHTML = '';

      // Sort by date (newest first)
      orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      orders.forEach(order => {
        const card = createOrderCard(order);
        container.appendChild(card);
      });
    }

    // Create order card
    function createOrderCard(order) {
      const card = document.createElement('div');
      card.className = 'order-card';
      card.setAttribute('data-testid', `order-${order.id}`);

      const date = new Date(order.createdAt).toLocaleDateString('it-IT', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const statusClass = order.status;
      const statusText = order.status === 'pending' ? 'In elaborazione' : 'Completato';

      let itemsHTML = '';
      order.items.forEach(item => {
        itemsHTML += `
          <div class="order-item">
            <div>
              <div>${item.productName}</div>
              <div class="order-item-details">${item.quantity} √ó ‚Ç¨${item.price.toFixed(2)}</div>
            </div>
            <div style="font-weight: 500;">
              ‚Ç¨${(item.price * item.quantity).toFixed(2)}
            </div>
          </div>
        `;
      });

      const paymentMethodLabels = {
        'credit-card': 'üí≥ Carta di Credito',
        'paypal': 'üÖøÔ∏è PayPal',
        'bank-transfer': 'üè¶ Bonifico Bancario'
      };

      card.innerHTML = `
        <div class="order-header">
          <div>
            <div class="order-number" data-testid="order-number-${order.id}">Ordine #${order.id}</div>
            <div class="order-date">${date}</div>
          </div>
          <div class="order-status ${statusClass}">${statusText}</div>
        </div>

        <div class="order-items">
          ${itemsHTML}
        </div>

        <div class="shipping-address">
          <strong>üìç Indirizzo di spedizione:</strong>
          ${order.shippingAddress.firstName} ${order.shippingAddress.lastName}<br>
          ${order.shippingAddress.address}<br>
          ${order.shippingAddress.zipCode} ${order.shippingAddress.city}<br>
          Tel: ${order.shippingAddress.phone}
        </div>

        <div class="order-footer">
          <div>
            <div style="font-size: 0.875rem; color: var(--secondary-color); margin-bottom: 0.25rem;">
              Metodo di pagamento
            </div>
            <div>${paymentMethodLabels[order.paymentMethod]}</div>
          </div>
          <div>
            <div style="font-size: 0.875rem; color: var(--secondary-color); margin-bottom: 0.25rem;">
              Totale
            </div>
            <div class="order-total" data-testid="order-total-${order.id}">‚Ç¨${order.total.toFixed(2)}</div>
          </div>
        </div>
      `;

      return card;
    }
  </script>
</body>
</html>
